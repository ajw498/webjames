# Makefile for WebJames the web server
#
# Parts common to all builds

WIMPSLOT_UNIXLIB = 400k
WIMPSLOT_SCL = 144k
WIMPSLOT_PHP = 2000k
WIMPSLOT_DEBUG = 3000k

CFLAGS = $(THROWBACK) $(DEPEND) $(INCLUDE) $(WARNINGS) $(OPTIMISATION) $(DEBUG) $(FLAGS)
LINKFLAGS = $(LINKDEBUG)

OBJECTS = \
	main.o\
	webjames.o\
	wjstring.o\
	snprintf.o\
	ip.o\
	stat.o\
	datetime.o\
	report.o\
	write.o\
	openclose.o\
	read.o\
	cache.o\
	coding.o\
	attributes.o\
	resolve.o\
	cacheheap.o\
	handler.o\
	staticcontent.o\
	webjamesscript.o\
	cgiscript.o\
	sendasis.o\
	content.o\
	serverparsed.o

LIBS = \
	$(OSLIB)\
	$(STUBS)\
	$(REGEX)\
	$(MEMCHECKLIB)


all: !RunImage !Run attributes config
	@echo

!RunImage: $(OBJECTS)
	$(LINK) -o $@ $(LINKFLAGS) $(PHP_LDFLAGS) $(OBJECTS) $(LIBS) $(PHP_LIBS)
	$(SQUEEZE)

.c.o:
	$(MEMCHECK) $(CC) -c $(CFLAGS) $(PHP_CFLAGS) $< -o $@

clean:
	-rm !RunImage
	-rm !Run
	-rm config
	-rm attributes
	-rm log
	-rm clf
	-rm stderr
	-rm *.o

!Run: !Run-default
	sed -e "s/|wimpslot/WimpSlot -min $(WIMPSLOT) -max $(WIMPSLOT)/" -e "s/|stderr$(STDERR)//" -e "s/|typestderr$(TYPESTDERR)//" !Run-default > $@
	$(SETTYPE)


attributes: attributes-default
	sed -e "s/dummy/dummy/" -e "s/$(REMOVE_ATTRIBUTE)//" attributes-default > $@

config: config-default
	sed -e "s/dummy/dummy/" -e "s/$(REMOVE_CONFIG)//" config-default > $@

dist: all
	cd ..
	-rm webjames.zip
	-rm source.zip
	-rm libphp.zip
	-rm libs.zip
	zip -r -9 webjames/zip !WebJames Site Licence -x */o/* *CVS* *stderr *log *clf *build* *Makefile */c/* */h/* *-default
	zip -r -9 source/zip !WebJames Site Licence -x */o/* *CVS* *stderr *log *clf *!Run *!RunImage *attributes *config
	zip -r -9 -j libs/zip PHP/ReadMe-Libs C:regex.libregex C:libpng.libpng C:zlib.libz C:libjpeg.libjpeg C:gd-1/8/4.libgd
	cd PHP
	zip -r -9 ^.libphp/zip build h libphp4 ReadMe -x */o/* *CVS*
	cd ../!WebJames


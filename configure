#!/bin/sh
#
# $Id: configure,v 1.9 2003/02/08 19:02:48 ajw Exp $
#

# Make sure everything is pristine
if test -f Makefile; then
  make clean
fi

LOG=-DLOG
CGISCRIPT=-DCGISCRIPT
WEBJAMESSCRIPT=-DWEBJAMESSCRIPT
SSI=-DSSI
SENDASIS=-DSENDASIS
CONTENT=-DCONTENT
AUTOINDEX=-DAUTOINDEX
PHP=
LIBDIR=$PREFIX

for X in "$@"; do
  case $X in
    --enable-log) ;;
    --disable-log) LOG=;;
    --enable-cgiscript) ;;
    --disable-cgiscript) CGISCRIPT=;;
    --enable-webjamesscript) ;;
    --disable-webjamesscript) WEBJAMESSCRIPT=;;
    --enable-ssi) ;;
    --disable-ssi) SSI=;;
    --enable-sendasis) ;;
    --disable-sendasis) SENDASIS=;;
    --enable-content) ;;
    --disable-content) CONTENT=;;
    --enable-autoindex) ;;
    --disable-autoindex) AUTOINDEX=;;
    --enable-php) PHP=-DPHP;;
    --disable-php) ;;
    --lib-dir=*) LIBDIR=`echo "$X" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
    *) echo configure: unknown option $X;;
  esac
done

for X in src scripts/chat scripts/tgif scripts/counter; do
  if test -d $X/c; then
    echo "Renaming files ($X)..."
    (cd $X/c && find * -type f | sed 's/.*/mv & ..\/&.c/' | /bin/sh)
    (cd $X/h && find * -type f | sed 's/.*/mv & ..\/&.h/' | /bin/sh)
    rmdir $X/c $X/h
  fi
done

echo Generating Makefiles...

cat > Makefile << EOF
# Top level Makefile, generated by configure

all:
	(cd src; \$(MAKE) LIBDIR=$LIBDIR UP=.. DIRSEP=/)
	(cd scripts; \$(MAKE))

clean:
	(cd src; \$(MAKE) LIBDIR=$LIBDIR UP=.. DIRSEP=/ clean)
	(cd scripts; \$(MAKE) clean)

cvsclean: clean
	rm -f src/Makefile
	rm -f Makefile
	rm -f src/build/php
	rm -f *.zip

EOF

cat > src/Makefile << EOF
# src/Makefile, generated by configure

FLAGS = $LOG $CGISCRIPT $SSI $WEBJAMESSCRIPT $SENDASIS $CONTENT $PHP $AUTOINDEX

include build/cross
EOF
if ! test -z $PHP; then
cat >> src/Makefile << EOF
-include build/php
EOF
fi
cat >> src/Makefile << EOF
include build/common

EOF

